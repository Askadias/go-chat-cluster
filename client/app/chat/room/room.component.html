<div class="room {{className}}" *ngIf="_room">
  <mat-toolbar color="accent" class="room-toolbar">
    <button *ngIf="isMobile" class="flat-button md-36" (click)="back.emit($event)">
      <mat-icon class="md-36">arrow_back</mat-icon>
    </button>
    <button class="flat-button md-36 room-menu" [matMenuTriggerFor]="menu">
      <mat-icon>more_vert</mat-icon>
    </button>
    <mat-menu #menu="matMenu">
      <button mat-menu-item (click)="close.emit($event)">
        <mat-icon>close</mat-icon>
        <span>Close Chat</span>
      </button>
      <button mat-menu-item (click)="dismiss.emit($event)">
        <mat-icon>delete_forever</mat-icon>
        <span>Exit and Remove History</span>
      </button>
    </mat-menu>
  </mat-toolbar>
  <div class="room-bg"></div>
  <div class="chat-log-container">
    <div class="chat-log">
      <div class="chat-messages" #chatLogElement (scroll)="loadHistory()">
        <div class="loading-zone"></div>
        <div *ngFor="let message of _room.messages; trackBy: trackByMessageId; let i = index"
             class="chat-message"
             [class.mine]="message.from == _room.me.id"
             [class.join]="isNearestMessage(message, i)"
             [class.head]="isHeadMessage(message, i)">
          <div class="chat-message-from" *ngIf="isHeadMessage(message, i)">
            <div class="chat-avatar-container" fxFlex="48px">
              <img src="{{ getAvatar(message.from) }}"
                   class="chat-avatar"
                   *ngIf="getAvatar(message.from); else defaultAvatar"/>
              <ng-template #defaultAvatar>
                <img src="../../../assets/img/default-avatar.png" class="chat-avatar"/>
              </ng-template>
            </div>
          </div>
          <div class="chat-message-text" [innerHtml]="message.body | newline">
          </div>
          <div class="chat-message-timestamp" *ngIf="isHeadMessage(message, i)">
              {{ getTimestamp(message) | date:'medium' }}
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="chat-input">
    <form class="chat-form" fxLayout="row" fxLayoutAlign="space-between center" (keydown)="sendOnEnter($event)">
      <mat-form-field class="chat-input-field">
        <textarea matInput id="message" name="message" placeholder="Message"
                  matTextareaAutosize matAutosizeMinRows="1" matAutosizeMaxRows="2"
                  [(ngModel)]="_room.newMessage"></textarea>
      </mat-form-field>
      <button class="flat-button chat-emoji-btn" type="button" (click)="toggleEmojiPicker()">
        <mat-icon class="md-24">tag_faces</mat-icon>
      </button>
      <div class="emoji-picker" [class.show]="emojiPickerOpened">
        <div class="emoji-close-overlay" (click)="emojiPickerOpened = false"></div>
        <emoji-mart title="Pick your emojiâ€¦"
                    perLine="7"
                    emojiTooltip="true"
                    title=""
                    native="true"
                    (emojiClick)="pickEmoji($event);">
        </emoji-mart>
      </div>
      <button class="flat-button chat-send-btn" type="submit" (click)="sendMessage()">
        <mat-icon class="md-24">send</mat-icon>
      </button>
    </form>
  </div>
</div>
